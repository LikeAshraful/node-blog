const express=require("express"),bodyParser=require("body-parser"),mongoose=require("mongoose"),expressLayouts=require("express-ejs-layouts"),session=require("express-session"),flash=require("connect-flash"),passport=require("passport");require("dotenv").config(),require("./config/passport");const app=express();mongoose.connect("mongodb://localhost:27017/blogDB");const postSchema=new mongoose.Schema({title:String,content:String,categories:[String],tags:[String],createdAt:{type:Date,default:Date.now}}),Post=mongoose.model("Post",postSchema);app.use(bodyParser.urlencoded({extended:!0})),app.use(express.static("public")),app.set("view engine","ejs"),app.use(expressLayouts),app.set("layout","layouts/main"),app.use(session({secret:"your_secret_key",resave:!1,saveUninitialized:!1})),app.use(passport.initialize()),app.use(passport.session()),app.use(flash()),app.use(((req,res,next)=>{res.locals.currentUser=req.user,res.locals.success_msg=req.flash("success_msg"),res.locals.error_msg=req.flash("error_msg"),res.locals.error=req.flash("error"),next()}));const{ensureAuthenticated:ensureAuthenticated}=require("./middlewares/auth"),authRoutes=require("./routes/auth");app.use("/",authRoutes),app.get("/",((req,res)=>{res.render("dashboard")})),app.get("/posts",(async(req,res)=>{const posts=await Post.find();res.render("posts/index",{posts:posts})})),app.get("/posts/:id",(async(req,res)=>{const post=await Post.findById(req.params.id);res.render("post",{post:post})})),app.get("/post/create",ensureAuthenticated,((req,res)=>{res.render("posts/create")})),app.post("/post/store",ensureAuthenticated,(async(req,res)=>{const post=new Post({title:req.body.postTitle,content:req.body.postContent,categories:req.body.postCategories.split(",").map((item=>item.trim())),tags:req.body.postTags.split(",").map((item=>item.trim()))});await post.save(),res.redirect("/posts")})),app.get("/categories/:category",(async(req,res)=>{const posts=await Post.find({categories:req.params.category});res.render("home",{posts:posts})})),app.listen(3e3,(()=>{console.log("Server is running on http://localhost:3000")}));